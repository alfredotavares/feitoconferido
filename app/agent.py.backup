from google.adk.agents import Agent
import json
import os

def load_reports():
    """Carrega relatÃ³rios da pasta data"""
    reports = []
    base_path = os.path.join(os.path.dirname(__file__), '..', 'data')
    
    if not os.path.exists(base_path):
        return reports
    
    try:
        for file in os.listdir(base_path):
            if file.endswith('.json'):
                with open(os.path.join(base_path, file), 'r') as f:
                    report = json.load(f)
                    report['_source_file'] = file
                    reports.append(report)
    except Exception:
        pass
    
    return reports

def load_criterios_auto_gerados():
    """Carrega critÃ©rios auto-gerados baseados na base de dados"""
    criterios_text = ""
    criterios_path = os.path.join(os.path.dirname(__file__), '..', 'criterios')
    
    if not os.path.exists(criterios_path):
        return "âŒ CritÃ©rios ainda nÃ£o foram gerados. Execute o script gerar_criterios.py"
    
    try:
        criterios_text += "=== CRITÃ‰RIOS AUTO-GERADOS BASEADOS NA SUA BASE DE DADOS ===\n\n"
        
        files_found = []
        for file in os.listdir(criterios_path):
            if file.endswith('.txt'):
                files_found.append(file)
                criterios_text += f"--- {file.upper()} ---\n"
                with open(os.path.join(criterios_path, file), 'r', encoding='utf-8') as f:
                    criterios_text += f.read() + "\n\n"
        
        if files_found:
            criterios_text += f"Total de arquivos de critÃ©rios carregados: {len(files_found)}\n"
            criterios_text += f"Arquivos: {', '.join(files_found)}\n\n"
        else:
            return "âŒ Nenhum arquivo de critÃ©rio encontrado na pasta criterios/"
            
        return criterios_text
        
    except Exception as e:
        return f"âŒ Erro ao carregar critÃ©rios: {e}"

def analisar_conformidade(pergunta: str = "") -> str:
    """Analisa conformidade usando critÃ©rios auto-gerados da prÃ³pria base"""
    reports = load_reports()
    criterios = load_criterios_auto_gerados()
    
    if not reports:
        return "âŒ Nenhum relatÃ³rio encontrado na pasta data/"
    
    if "âŒ" in criterios:
        return criterios  # Retorna erro se houver
    
    # Contexto especial para critÃ©rios auto-gerados
    context = f"""
MISSÃƒO: Analisar conformidade usando CRITÃ‰RIOS AUTO-GERADOS da prÃ³pria base de dados

DADOS ORIGINAIS DOS SISTEMAS:
{json.dumps(reports, indent=2, ensure_ascii=False)}

{criterios}

PERGUNTA DO USUÃRIO: {pergunta}

INSTRUÃ‡Ã•ES ESPECIAIS - CRITÃ‰RIOS AUTO-GERADOS:
1. Os critÃ©rios foram extraÃ­dos AUTOMATICAMENTE dos prÃ³prios dados
2. Compare valores atuais vs valores ideais/mÃ­nimos definidos nos critÃ©rios
3. Identifique onde hÃ¡ conformidade (âœ…) e nÃ£o-conformidade (âŒ)
4. Use âš ï¸ para situaÃ§Ãµes que precisam atenÃ§Ã£o
5. Seja especÃ­fico: "Score atual X% vs mÃ­nimo Y% definido no critÃ©rio"
6. Priorize por criticidade: CRÃTICA > ALTA > MÃ‰DIA
7. Para gaps/issues jÃ¡ identificados, sugira aÃ§Ãµes especÃ­ficas
8. Relacione com evidÃªncias encontradas nos dados originais

FORMATO DE RESPOSTA ESPERADO:
ğŸ” SISTEMA: [nome]
ğŸ“Š CRITÃ‰RIOS APLICÃVEIS:
   âœ…/âŒ/âš ï¸ [Nome do CritÃ©rio]: [Valor Atual] vs [Valor Esperado] - [Status]
   ğŸ“‹ EvidÃªncia: [dados que suportam a anÃ¡lise]
ğŸ’¡ AÃ‡Ã•ES RECOMENDADAS: [baseado nos gaps identificados]
ğŸ¯ PRIORIDADE: [CRÃTICA/ALTA/MÃ‰DIA baseado nos critÃ©rios]
"""
    
    return context

root_agent = Agent(
    name="feito_conferido_auto_agent",
    model="gemini-2.0-flash",
    description="Especialista que analisa conformidade usando critÃ©rios auto-gerados da prÃ³pria base de dados",
    instruction="""VocÃª Ã© o FEITO CONFERIDO com CRITÃ‰RIOS AUTO-GERADOS.

DIFERENCIAL: Os critÃ©rios foram extraÃ­dos automaticamente da prÃ³pria base de dados, entÃ£o vocÃª conhece:
- Valores atuais vs ideais
- Gaps jÃ¡ identificados
- Issues especÃ­ficos encontrados
- Scores e mÃ©tricas reais

Use analisar_conformidade para:
- Comparar dados atuais vs critÃ©rios extraÃ­dos
- Identificar melhorias baseadas nos prÃ³prios dados
- Sugerir aÃ§Ãµes especÃ­ficas para gaps conhecidos
- Priorizar por criticidade definida automaticamente

Seja preciso e baseado em evidÃªncias dos prÃ³prios dados.""",
    tools=[analisar_conformidade]
)
